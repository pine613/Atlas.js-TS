/**
 * Atlas.js v0.5.4
 * https://github.com/steelydylan/Atlas.js
 * Copyright steelydylan
 * <http://steelydylan.phpapps.jp/>
 * Released under the MIT license.
 */
(function(){var v=[];var w=[];var z=[];var A=0;var B=(function(){var a=navigator.userAgent;if((a.indexOf('iPhone')>0&&a.indexOf('iPad')==-1)||a.indexOf('iPod')>0||a.indexOf('Android')>0)return true;else return false})();var C=(function(e){var a=window.matchMedia("(orientation: portrait)");var b="";if(a.matches)return"portrait";else return"landscape"})();var D=function(a,b,e){var c=e.which;switch(c){case 13:a.enter=true;b.enter=true;break;case 16:a.shift=true;b.shift=true;break;case 32:a.space=true;b.space=true;break;case 39:a.right=true;b.right=true;break;case 37:a.left=true;b.left=true;break;case 38:a.up=true;b.up=true;break;case 40:a.down=true;b.down=true;break;case 8:a.backspace=true;b.backspace=true;break}for(var i=0;i<26;i++){if(i+65==c){var d=String.fromCharCode(i+97);a[d]=true;b[d]=true;break}}};var E=function(a){a.enter=false;a.shift=false;a.space=false;a.right=false;a.left=false;a.up=false;a.down=false;a.backspace=false;for(var i=0;i<26;i++){a[String.fromCharCode(i+97)]=false}};var F=(function(){var a=new Object();E(a);return a})();Atlas=function(){window.App=I;window.Sprite=M;window.Text=O;window.Shape=L;window.Scene=H;window.Map=N};Atlas.createClass=function(a,b){var c=function(){this.initialize.apply(this,arguments)};if(typeof a=="function"&&typeof b=="object"){c.prototype=Object.create(a.prototype);c.prototype.inherit=function(){this.initialize=this.superClass.prototype.initialize;this.superClass=this.superClass.prototype.superClass;if(this.initialize)this.initialize.apply(this,arguments)}}else if(typeof a=="object"&&b==null){b=a}for(var d in b){c.prototype[d]=b[d]}c.prototype.superClass=a;return c};var G=Atlas.createClass({isMobile:B,orientation:C,initialize:function(){this.eventListener=new Object();this.visible=true;this.eventEnable=false;var a=this.eventListener;a.touchStart=false;a.touchMove=false;a.touchEnd=false;a.keyUp=false;a.keyDown=false;a.orientationChange=false},setPosition:function(x,y){this.x=x;this.y=y;return this},saveData:function(a){var b=new Object();for(var i in this){if(typeof(this[i])!='function')b[i]=this[i]}localStorage.setItem(a,JSON.stringify(b))},getData:function(a){var b=JSON.parse(localStorage.getItem(a));for(var i in b)this[i]=b[i]},getTouchPosition:function(e){var a=this.field;var b=parseInt(a.width)/parseInt(a.style.width);var c=parseInt(a.height)/parseInt(a.style.height);var d=new Object();var f=a.getBoundingClientRect();var x=parseInt(f.left);var y=parseInt(f.top);if(isNaN(x))x=0;if(isNaN(y))y=0;if(e){if(!B||(B&&e.touches[0])){d.x=(B?e.touches[0].pageX:e.pageX)-x;d.y=(B?e.touches[0].pageY:e.pageY)-y}else{d.x=-1;d.y=-1}}else{d.x=event.x-x;d.y=event.y-y}d.x=parseInt(d.x*b);d.y=parseInt(d.y*c);return d},handleEvent:function(e){if(this.eventEnable){e.preventDefault();var a=this.getTouchPosition(e);var b=e.type;if(b=="keydown"||b=="keyup"){var c=new Object();for(var i in F)c[i]=F[i];D(c,F,e)}switch(b){case'touchstart':if(this.touchStart)this.touchStart(a);break;case'mousedown':if(this.touchStart)this.touchStart(a);break;case'touchmove':if(this.touchMove)this.touchMove(a);break;case'mousemove':if(this.touchMove)this.touchMove(a);break;case'touchend':if(this.touchEnd)this.touchEnd();break;case'mouseup':if(this.touchEnd)this.touchEnd();break;case'keydown':if(this.keyDown)this.keyDown(F);break;case'keyup':if(this.keyUp)this.keyUp(c);break}}},useEvent:function(){var a=this.field;var b=this.eventListener;if(this.touchStart&&b.touchStart==false){if(B)a.addEventListener("touchstart",this,false);else a.addEventListener("mousedown",this,false);b.touchStart=true}if(this.touchMove&&b.touchMove==false){if(B)a.addEventListener("touchmove",this,false);else a.addEventListener("mousemove",this,false);b.touchMove=true}if(this.touchEnd&&b.touchEnd==false){if(B)a.addEventListener("touchend",this,false);else a.addEventListener("mouseup",this,false);b.touchEnd=true}if(this.keyUp&&b.keyUp==false){a.addEventListener("keyup",this,false);b.keyUp=true}if(this.keyDown&&b.keyDown==false){a.addEventListener("keydown",this,false);b.keyDown=true}},remove:function(){this._remove=true},getRand:function(a,b){return~~(Math.random()*(b-a+1))+a},getSound:function(a){for(var i=0,n=w.length;i<n;i++){if(a==w[i].name)this.sound=new Audio(w[i].src)}},soundClonePlay:function(){var a=this.sound;if(a){(new Audio(a.src)).play()}},soundLoopPlay:function(){var a=this.sound;if(a){if(!a.loop){a.addEventListener('ended',function(){this.currentTime=0;this.play()},false)}a.loop=true;a.play()}},soundReplay:function(){var a=this.sound;if(a){a.load();a.play()}},soundStop:function(){var a=this.sound;if(!a.paused){a.pause();a.currentTime=0}else{a.load()}},soundPlay:function(){var a=this.sound;if(a)a.play()},soundPause:function(){var a=this.sound;if(a)a.pause()},soundGetCount:function(){var a=this.sound;if(a)return a.currentTime},soundSetCount:function(a){var b=this.sound;if(b)b.currentTime=a},soundGetVolume:function(){var a=this.sound;if(a)return a.volume},soundSetVolume:function(a){var b=this.sound;if(b)b.volume=a},soundGetAlltime:function(){var a=this.sound;if(a)return a.duration},soundIsPlaying:function(){var a=this.sound;if(a)return!a.paused}});var H=Atlas.createClass(Array,{initialize:function(){this.inherit();this._remove=false},addChildren:function(){for(var i=0,n=arguments.length;i<n;i++){this.addChild(arguments[i])}},remove:function(){this._remove=true},addChild:function(a){a.parent=this;this.push(a)},setImage:function(a){this.image=a},setColor:function(a){this.color=a},_enterFrame:function(e){if(this.enterFrame)this.enterFrame();for(var i=0,n=this.length;i<n;i++){var a=this[i];if(a.useEvent)a.useEvent();if(a.enterFrame)a.enterFrame();if(a.tween)a.tween();if(a.visible)a.draw();if(a._remove){this.splice(i,1);delete a;i--;n--}}}});var I=Atlas.createClass(G,{initialize:function(a){this.inherit();var b=document.createElement("style");b.media='screen';b.type="text/css";document.getElementsByTagName("head")[0].appendChild(b);var c=document.getElementById(a);c.width=320;c.height=480;c.tabIndex='1';c.focus();document.body.style.margin="0em";var d=navigator.userAgent;if(B){c.style.width=window.innerWidth+"px";c.style.height=window.innerHeight+"px";c.addEventListener("touchstart",function(){this.focus()})}else{c.style.width=480+"px";c.style.height=620+"px";c.addEventListener("mousedown",function(){this.focus()});c.addEventListener("keyup",function(){E(F)},false)}this._css=b;this.field=c;this.ctx=c.getContext('2d');this.fps=30;this.scene=new H();this.scene.parent=this},addChild:function(a){a.ctx=this.ctx;a.field=this.field;a.eventEnable=true;this.scene.addChild(a)},addChildren:function(){for(var i=0,n=arguments.length;i<n;i++)this.addChild(arguments[i])},centerize:function(){var a=this.field.style;a.marginTop=-parseInt(a.height)/2+"px";a.marginLeft=-parseInt(a.width)/2+"px";a.top='50%';a.left='50%';a.position='absolute'},fitWindow:function(){this.setSize(window.innerWidth,window.innerHeight);var a=this;window.onresize=function(){a.setSize(window.innerWidth,window.innerHeight)}},setQuality:function(a,b){var c=this.field;c.width=a;c.height=b},setSize:function(a,b){var c=this.field.style;c.width=a+"px";c.height=b+"px"},loadingScene:function(a){this.preScene=a;this.preScene.parent=this},mainScene:function(a){console.log("mainScene will be removed, please use 'this.enterFrame = function(){....};' instead");this.enterFrame=a},_enterFrame:function(){var a=this.field;this.useEvent();this.ctx.clearRect(0,0,a.width,a.height);if(A>0&&this.preScene){this.preScene._enterFrame()}else if(A==0){A--}else{if(this.enterFrame)this.enterFrame();this.scene._enterFrame()}},pushScene:function(a){var b=this.ctx;var c=this.field;var d=this.scene;for(var i=0,n=d.length;i<n;i++){var e=d[i];e.eventEnable=false}for(var i=0,n=a.length;i<n;i++){a[i].ctx=b;a[i].field=c;a[i].eventEnable=true}a.parent=this;var f=this.field.style;f.background=null;f.backgroundColor="white";if(a.color)this.setColor(a.color);if(a.image)this.setImage(a.image);this.scene=a},setColor:function(a){var b=this.field.style;b.background=null;b.backgroundColor=a},setImage:function(a){var b=this.field.style;b.background="url("+a+") no-repeat center";b.backgroundSize="cover"},start:function(){var a=this.field;var b=this;this.ctx.clearRect(0,0,a.width,a.height);setInterval(function(){b._enterFrame()},1000/this.fps)},load:function(){function getExtention(a){var b;if(!a){return b}var c=a.split(".");var d=c.length;if(d===0){return b}b=c[d-1];return b}for(var i=0,n=arguments.length;i<n;i++){var e=arguments[i];var f=getExtention(e);var g=this._css;if(f=='wav'||f=='mp3'||f=='ogg'){var h=new Audio(e);h.name=e;A++;h.addEventListener("canplaythrough",function(){A--;console.log(this.src+" is loaded")});w.push(h)}else if(f=="TTF"||f=="ttf"){var j=document.createTextNode("@font-face{"+"font-family:'"+e+"';"+"src: url('"+e+"') format('truetype');"+"}");if(g.styleSheet)g.styleSheet.cssText=j;else g.appendChild(j);var k=new Object();k.name=e;k.url=e;z.push(k);console.log(e+" is loaded")}else{var h=new Image();h.src=e;h.name=e;h.onload=function(){A--;console.log(this.src+' is loaded')};v.push(h)}}},naming:function(){for(var t=0,l=arguments.length;t<l;t++){for(var i=0,n=w.length;i<n;i++){if(w[i].name==arguments[t][0]){w[i].name=arguments[t][1]}}for(var i=0,n=v.length;i<n;i++){if(v[i].name==arguments[t][0]){v[i].name=arguments[t][1]}}for(var i=0,n=z.length;i<n;i++){if(z[i].name==arguments[t][0]){z[i].name=arguments[t][1];var a=document.createTextNode("@font-face{"+"font-family:'"+z[i].name+"';"+"src: url('"+z[i].url+"') format('truetype');"+"}");var b=this._css;if(b.styleSheet)b.styleSheet.cssText=a;else b.appendChild(a)}}}}});var J=function(a,b,c){var d=a.mover;var e=d[d.length-1];if(e&&e.and){var f=e}else{var f=new Object();d.push(f)}f.time=0;if(c)f.frame=c;f.loop=false;f.and=false;f[b]=true;return f};var K=Atlas.createClass(G,{initialize:function(a,b){this.inherit();this.x=0;this.y=0;this.rot=0;this._remove=false;this.width=a;this.height=b;this.collisionShape="box";this.mover=[];this.moverIndex=0;this.alpha=1;this.field},tween:function(){var a=this.mover;var b=a.length;if(this.moverIndex<b){var c=a[this.moverIndex];if(c.animate)this._animate(c);if(c.moveTo)this._moveTo(c);if(c.moveBy)this._moveBy(c);if(c.rotateBy)this._rotateBy(c);if(c.scaleBy)this._scaleBy(c);c.time++;if(c.time>c.frame){if(c.loop){this._refresh();this.moverIndex=0}else{if(c.kind=="moveTo"||c.kind=="moveBy"){this.setPosition(c.toX,c.toY)}this.moverIndex++}if(this.moverIndex>b){this.stop()}}}},animate:function(a,b,c){var d=J(this,"animate",c);d.array=a;d.frameRate=b;d.frameIdx=0;return this},_animate:function(a){if(a.time==0)this.frame=a.array[0];if(a.time%a.frameRate==0){a.frameIdx=(a.frameIdx+1)%a.array.length;this.frame=a.array[a.frameIdx]}},_refresh:function(){var a=this.mover;for(var i=0,n=a.length;i<n;i++){var b=a[i];if(b.time)b.time=0}},moveTo:function(x,y,a){var b=J(this,"moveTo",a);b.toX=x;b.toY=y;return this},_moveTo:function(a){if(a.time==0){a.diffX=a.toX-this.x;a.diffY=a.toY-this.y}this.x=a.toX-a.diffX*(1-a.time/a.frame);this.y=a.toY-a.diffY*(1-a.time/a.frame)},moveBy:function(x,y,a){var b=J(this,"moveBy",a);b.diffX=x;b.diffY=y;return this},_moveBy:function(a){if(a.time==0){a.toX=this.x+a.diffX;a.toY=this.y+a.diffY}this.x=a.toX-a.diffX*(1-a.time/a.frame);this.y=a.toY-a.diffY*(1-a.time/a.frame)},scaleBy:function(x,y,a){var b=J(this,"scaleBy",a);b.scaleX=x;b.scaleY=y;return this},_scaleBy:function(a){if(a.time==0){a.toWidth=this.width*a.scaleX;a.toHeight=this.height*a.scaleY;a.diffWidth=a.toWidth-this.width;a.diffHeight=a.toHeight-this.height}this.width=a.toWidth-a.diffWidth*(1-a.time/a.frame);this.height=a.toHeight-a.diffHeight*(1-a.time/a.frame)},delay:function(a){var b=J(this,"delay",a);this.mover.push(b);return this},and:function(){var a=this.mover;var b=a[a.length-1];if(b)b.and=true;return this},stop:function(){this.mover=[];this.moverIndex=0;return this},loop:function(){var a=this.mover[this.mover.length-1];a.loop=true;return this},rotateBy:function(a,b){var c=J(this,"rotateBy",b);c.diffAngle=a;return this},_rotateBy:function(a){if(a.time==0)a.toAngle=this.rot+a.diffAngle;this.rot=a.toAngle-a.diffAngle*(1-a.time/a.frame)},intersect:function(a,b){if(this.collisionShape=="box"){var x=a-(this.x+this.width/2);var y=b-(this.y+this.height/2);var r=this.rot;var s=Math.sin(-r);var c=Math.cos(-r);var d=Math.abs(x*c-y*s);var e=Math.abs(x*s+y*c);if(d<this.width/2.0&&e<this.height/2.0)return true;return false}else if(this.collisionShape=="circle"){var f=this.width/2;var x=a-(this.x+f);var y=b-(this.y+f);if(Math.sqrt(x*x+y*y)<f)return true;return false}else{return false}},within:function(c,d){if(this.collisionShape=="box"){var e=this.x+this.width/2;var f=this.y+this.height/2}else if(this.collisionShape=="circle"){var g=this.width/2;var e=this.x+g;var f=this.y+g}else{return false}if(c.collisionShape=="box"){var h=c.x+c.width/2;var i=c.y+c.height/2;var j=-c.rot;var k=Math.cos(j)*(e-h)-Math.sin(j)*(f-i)+h;var l=Math.sin(j)*(e-h)+Math.cos(j)*(f-i)+i;var x,y;if(k<c.x)x=c.x;else if(k>c.x+c.width)x=c.x+c.width;else x=k;if(l<c.y)y=c.y;else if(l>c.y+c.height)y=c.y+c.height;else y=l;var a=Math.abs(k-x);var b=Math.abs(l-y)}else if(c.collisionShape=="circle"){var m=c.width/2;var x=c.x+m;var y=c.y+m;var a=Math.abs(e-x);var b=Math.abs(f-y);d+=m}else{return false}if(Math.sqrt((a*a)+(b*b))<d)return true;return false},scale:function(a,b){this.width*=a;this.height*=b;return this}});var L=new Object();L.Box=Atlas.createClass(K,{initialize:function(a,b,c){this.inherit(b,c);this.color=a},draw:function(){var a=this.ctx;a.globalAlpha=this.alpha;a.beginPath();a.fillStyle=this.color;var b=this.x+this.width/2;var c=this.y+this.height/2;a.save();a.translate(b,c);a.rotate(this.rot);a.translate(-b,-c);a.fillRect(this.x,this.y,this.width,this.height);a.restore();a.globalAlpha=1}});L.Circle=Atlas.createClass(K,{initialize:function(a,b){this.inherit(b*2,0);this.color=a;this.collisionShape="circle"},draw:function(){var a=this.ctx;a.globalAlpha=this.alpha;a.beginPath();a.fillStyle=this.color;var b=this.width/2;a.arc(this.x+b,this.y+b,b,0,Math.PI*2,false);a.fill();a.globalAlpha=1}});var M=Atlas.createClass(K,{initialize:function(a,b,c){this.inherit(b,c);this.spriteWidth=b;this.spriteHeight=c;this.getImage(a);this.frame=0},setSpriteSize:function(a,b){this.spriteWidth=a;this.spriteHeight=b},getImage:function(a,b,c){if(b&&c)this.setSpriteSize(b,c);var d=v.length;for(var i=0;i<d;i++)if(v[i].name==a)this.img=i},draw:function(){var a=this.ctx;var b=this.frame;var c=v[this.img];var d=this.spriteWidth;var e=this.spriteHeight;var f=this.width/2;var g=this.height/2;var h=c.width/d;var i=c.height/e;var j=this.width/d;var k=this.height/e;var l=(b%h)*d;var m=(~~(b/h)%i)*e;a.save();a.translate(this.x+f,this.y+g);a.rotate(this.rot);a.translate(-f,-g);a.scale(j,k);a.drawImage(c,l,m,d,e,0,0,d,e);a.restore()}});var N=Atlas.createClass(M,{initialize:function(a,b,c){this.inherit(a,b,c);this.drawData;this.hitData},intersect:function(a,b){var c=this.hitData;var x=c[0].length;var y=c.length;var d=this.width;var e=this.height;var f=this.x;var g=this.y;for(var i=0;i<y;i++){for(var t=0;t<x;t++){if(c[i][t]==1&&f+t*d<a&&a<f+(t+1)*d&&g+i*e<b&&b<g+(i+1)*e)return true}}return false},draw:function(){var a=this.drawData;var x=a[0].length;var y=a.length;var b=this.width;var c=this.height;var d=this.x;var e=this.y;var i=0;var t=0;var f=field.height;var g=field.width;var h;var j=v[this.img];var k=this.spriteWidth;var l=this.spriteHeight;var m=this.width/2;var n=this.height/2;var o=j.width/k;var p=j.height/l;var q=this.width/k;var r=this.height/l;var s=(h%o)*k;var u=(~~(h/o)%p)*l;while(i<y){while(t<x){h=a[i][t];if(h>=0&&f>e+c*i&&e+c*(i+1)>0&&g>d+b*t&&d+b*(t+1)>0){var s=(h%o)*k;var u=(~~(h/o)%p)*l;ctx.save();ctx.translate(this.x,this.y);ctx.scale(q,r);ctx.drawImage(j,s,u,k,l,0,0,k,l);ctx.restore()}this.x+=b;t++}this.y+=c;i++;this.x=d;t=0}this.x=d;this.y=e}});var O=Atlas.createClass(G,{initialize:function(a,b,c,d){this.inherit();this.x=0;this.y=0;this.alpha=1;this.spaceWidth=0;if(d)this.font="'"+d+"'";else this.font="'Meiryo'";if(c)this.size=c+"pt";else this.size="10pt";if(a)this.string=a;else this.string="";if(b)this.color=b;else this.color="white"},setSize:function(a){this.size=a+"pt"},setFont:function(a){this.font="'"+a+"'"},intersect:function(x,y){var a=this.ctx;a.font=this.font;var b=a.measureText(this.string).width;var c=a.measureText('m').width*1.5;if(x>this.x&&x<this.x+b&&y>this.y-c&&y<this.y)return true;else return false},draw:function(){var x=this.x;var y=this.y;var a=this.ctx;var b=this.string.split('<br>');var c=b.length;a.globalAlpha=this.alpha;a.font=this.size+" "+this.font;a.fillStyle=this.color;if(c>1){var d=a.measureText('a').width*1.5+this.spaceWidth;for(var i=0;i<c;i++){a.fillText(b[i],x,y);y+=d}}else a.fillText(this.string,x,y);a.globalAlpha=1}});Atlas.App=I;Atlas.Sprite=M;Atlas.Text=O;Atlas.Shape=L;Atlas.Scene=H;Atlas.Map=N})();
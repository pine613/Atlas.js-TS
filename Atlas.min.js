/**
 * Atlas.js v0.5.0
 * https://github.com/steelydylan/Atlas.js
 * Copyright steelydylan
 * <http://steelydylan.phpapps.jp/>
 * Released under the MIT license.
 */
(function(){var v=[];var w=[];var z=0;var A;var B;var C;var D;var E="black";var F=1;var G=false;Atlas=function(a){A=document.getElementById(a);A.width=320;A.height=480;document.body.style.margin="0em";B=A.getContext('2d');var b=navigator.userAgent;if((b.indexOf('iPhone')>0&&b.indexOf('iPad')==-1)||b.indexOf('iPod')>0||b.indexOf('Android')>0){A.style.width=window.innerWidth+"px";A.style.height=window.innerHeight+"px";G=true}else{A.style.width=480+"px";A.style.height=620+"px"}window.App=I;window.Sprite=L;window.Text=N;window.Shape=K;window.Group=O;window.Map=M};Atlas.createClass=function(a,b){var c=function(){this.initialize.apply(this,arguments)};if(typeof a=="function"&&typeof b=="object"){c.prototype=Object.create(a.prototype);c.prototype.inherent=function(){this.initialize=this.superClass.prototype.initialize;this.superClass=this.superClass.prototype.superClass;if(this.initialize)this.initialize.apply(this,arguments)}}else if(typeof a=="object"&&b==null){b=a}for(var d in b){c.prototype[d]=b[d]}c.prototype.superClass=a;return c};var H=Atlas.createClass({initialize:function(){this.key=new Object();var a=this.key;a.enter=false;a.shift=false;a.space=false;a.right=false;a.left=false;a.up=false;a.down=false;a.a=false;a.b=false;a._a=-1;a._b=-1},enableEvent:function(){for(var i=0,n=arguments.length;i<n;i++){var a=arguments[i];if(a=="touchStart"){if(G)A.addEventListener("touchstart",this,false);else A.addEventListener("mousedown",this,false)}else if(a=="touchMove"){if(G)A.addEventListener("touchmove",this,false);else A.addEventListener("mousemove",this,false)}else if(a=="touchEnd"){if(G)A.addEventListener("touchend",this,false);else A.addEventListener("mouseup",this,false)}else if(a=="keyDown"){document.addEventListener("keydown",this,false)}else if(a=="keyUp"){document.addEventListener("keyup",this,false)}}},handleEvent:function(e){switch(e.type){case'touchstart':this.touchStart(e);break;case'mousedown':this.touchStart(e);break;case'touchmove':this.touchMove(e);break;case'mousemove':this.touchMove(e);break;case'touchend':this.touchEnd(e);break;case'mouseup':this.touchMove(e);break;case'keydown':this.keyDown(e);break;case'keyup':this.keyUp(e);break}},getTouchPosition:function(e){e.preventDefault();var a=parseInt(A.width)/parseInt(A.style.width);var b=parseInt(A.height)/parseInt(A.style.height);var c=new Object();var d=A.getBoundingClientRect();if(e){var x=parseInt(d.left);var y=parseInt(d.top);if(isNaN(x))x=0;if(isNaN(y))y=0;if(!G||(G&&e.touches[0])){c.x=(G?e.touches[0].pageX:e.pageX)-x;c.y=(G?e.touches[0].pageY:e.pageY)-y}else{c.x=-1;c.y=-1}}else{c.x=event.x-x;c.y=event.y-y}c.x=parseInt(c.x*a);c.y=parseInt(c.y*b);return c},setKey:function(d,e){var f=function(a){return String.fromCharCode(a.charCodeAt(a.length-1)+1)};var g=function(a){var b;var c="a";for(var i=0;i<24;i++){if(a==c){b=65+i;break}c=f(c)}return b};if(d)key._a=g(d);if(e)key._b=g(e)},setKeyState:function(e){var a=e.which;var b=this.key;switch(a){case 13:b.enter=true;break;case 16:b.shift=true;break;case 32:b.space=true;break;case 39:b.right=true;break;case 37:b.left=true;break;case 38:b.up=true;break;case 40:b.down=true;break;case b._a:b.a=true;break;case b._b:b.b=true;break}},clearKeyState:function(){var a=this.key;a.enter=false;a.shift=false;a.space=false;a.right=false;a.left=false;a.up=false;a.down=false;a.a=false;a.b=false},getRand:function(a,b){return~~(Math.random()*(b-a+1))+a}});var I=Atlas.createClass(H,{ctx:B,isMobile:G,initialize:function(){this.fps=30;if(G){var a=window.matchMedia("(orientation: portrait)");if(a.matches){this.orientation="portrait"}else{this.orientation="landscape"}}},setBackgroundColor:function(a){E=a},setAlpha:function(n){F=n},centerize:function(){var a=A.style;a.marginTop=-parseInt(a.height)/2+"px";a.marginLeft=-parseInt(a.width)/2+"px";a.top='50%';a.left='50%';a.position='absolute'},fitWindow:function(){this.changeSize(window.innerWidth,window.innerHeight);var a=this;window.onresize=function(){a.changeSize(window.innerWidth,window.innerHeight)}},detectOrientation:function(b,c){if(this.isMobile){var d=this;window.addEventListener("orientationchange",function(){var a=window.matchMedia("(orientation: portrait)");if(a.matches){d.orientation="portrait"}else{d.orientation="landscape"}},false)}},changeQuality:function(a,b){A.width=a;A.height=b},changeSize:function(a,b){var c=A.style;c.width=a+"px";c.height=b+"px"},getQuality:function(){var a=new Object();a.width=A.width;a.height=A.height;return a},getSize:function(){var a=new Object();a.width=A.style.width;a.height=A.style.height;return a},mainScene:function(a){D=a},loadingScene:function(a){C=a},start:function(){B.fillStyle=E;B.globalAlpha=1;B.fillRect(0,0,A.width,A.height);setInterval(function(){B.fillStyle=E;B.globalAlpha=F;B.fillRect(0,0,A.width,A.height);B.globalAlpha=1;if(z<=0)D();else if(C)C()},1000/this.fps)},load:function(){function getExtention(a){var b;if(!a){return b}var c=a.split(".");var d=c.length;if(d===0){return b}b=c[d-1];return b}for(var i=0,n=arguments.length;i<n;i++){var e=arguments[i];var f=getExtention(e);if(f=='wav'||f=='mp3'||f=='ogg'){var g=new Audio(e);g.name=e;z++;g.addEventListener("canplaythrough",function(){z--;console.log(this.src+" is loaded")});w.push(g)}else{var g=new Image();g.src=e;g.name=e;g.onload=function(){z--;console.log(this.src+' is loaded')};v.push(g)}}},naming:function(){for(var t=0,l=arguments.length;t<l;t++){for(var i=0,n=w.length;i<n;i++){if(w[i].name==arguments[t][0]){w[i].name=arguments[t][1]}}for(var i=0,n=v.length;i<n;i++){if(v[i].name==arguments[t][0]){v[i].name=arguments[t][1]}}}}});var J=Atlas.createClass(H,{initialize:function(a,b){this.inherent();this.x=0;this.y=0;this.rot=0;this.width=a;this.height=b;this.collisionShape="box";this.alpha=1},intersect:function(a,b){if(this.collisionShape=="box"){var x=a-(this.x+this.width/2);var y=b-(this.y+this.height/2);var r=this.rot;var s=Math.sin(-r);var c=Math.cos(-r);var d=Math.abs(x*c-y*s);var e=Math.abs(x*s+y*c);if(d<this.width/2.0&&e<this.height/2.0)return true;return false}else if(this.collisionShape=="circle"){var f=this.width/2;var x=a-(this.x+f);var y=b-(this.y+f);if(Math.sqrt(x*x+y*y)<f)return true;return false}else{return false}},within:function(c,d){if(this.collisionShape=="box"){var e=this.x+this.width/2;var f=this.y+this.height/2}else if(this.collisionShape=="circle"){var g=this.width/2;var e=this.x+g;var f=this.y+g}else{return false}if(c.collisionShape=="box"){var h=c.x+c.width/2;var i=c.y+c.height/2;var j=-c.rot;var k=Math.cos(j)*(e-h)-Math.sin(j)*(f-i)+h;var l=Math.sin(j)*(e-h)+Math.cos(j)*(f-i)+i;var x,y;if(k<c.x)x=c.x;else if(k>c.x+c.width)x=c.x+c.width;else x=k;if(l<c.y)y=c.y;else if(l>c.y+c.height)y=c.y+c.height;else y=l;var a=Math.abs(k-x);var b=Math.abs(l-y)}else if(c.collisionShape=="circle"){var m=c.width/2;var x=c.x+m;var y=c.y+m;var a=Math.abs(e-x);var b=Math.abs(f-y);d+=m}else{return false}if(Math.sqrt((a*a)+(b*b))<d)return true;return false},scale:function(a,b){this.width*=a;this.height*=b},setPosition:function(x,y){this.x=x;this.y=y},getSound:function(a){for(var i=0,n=w.length;i<n;i++){if(a==w[i].name)this.sound=new Audio(w[i].src)}},soundClonePlay:function(){var a=this.sound;if(a){(new Audio(a.src)).play()}},soundLoopPlay:function(){var a=this.sound;if(a){if(!a.loop){a.addEventListener('ended',function(){this.currentTime=0;this.play()},false)}a.loop=true;a.play()}},soundReplay:function(){var a=this.sound;if(a){a.load();a.play()}},soundStop:function(){var a=this.sound;if(!a.paused){a.pause();a.currentTime=0}else{a.load()}},soundPlay:function(){var a=this.sound;if(a)a.play()},soundPause:function(){var a=this.sound;if(a)a.pause()},soundGetCount:function(){var a=this.sound;if(a)return a.currentTime},soundSetCount:function(a){var b=this.sound;if(b)b.currentTime=a},soundGetVolume:function(){var a=this.sound;if(a)return a.volume},soundSetVolume:function(a){var b=this.sound;if(b)b.volume=a},soundGetAlltime:function(){var a=this.sound;if(a)return a.duration},soundIsPlaying:function(){var a=this.sound;if(a)return!a.paused}});var K=new Object();K.Box=Atlas.createClass(J,{initialize:function(a,b,c){this.inherent(b,c);this.col=a},draw:function(){B.globalAlpha=this.alpha;B.beginPath();B.fillStyle=this.col;var a=this.x+this.width/2;var b=this.y+this.height/2;B.save();B.translate(a,b);B.rotate(this.rot);B.translate(-a,-b);B.fillRect(this.x,this.y,this.width,this.height);B.restore();B.globalAlpha=1}});K.Circle=Atlas.createClass(J,{initialize:function(a,b){this.inherent(b*2,0);this.col=a;this.collisionShape="circle"},draw:function(){B.globalAlpha=this.alpha;B.beginPath();B.fillStyle=this.col;var a=this.width/2;B.arc(this.x+a,this.y+a,a,0,Math.PI*2,false);B.fill();B.globalAlpha=1}});var L=Atlas.createClass(J,{initialize:function(a,b,c){this.inherent(b,c);this.spriteWidth=b;this.spriteHeight=c;this.getImage(a);this.frame=0},setSpriteSize:function(a,b){this.spriteWidth=a;this.spriteHeight=b},getImage:function(a,b,c){if(b&&c)this.setSpriteSize(b,c);var d=v.length;for(var i=0;i<d;i++)if(v[i].name==a)this.img=i},draw:function(){var a=this.frame;var b=v[this.img];var c=this.spriteWidth;var d=this.spriteHeight;var e=this.width/2;var f=this.height/2;var g=b.width/c;var h=b.height/d;var i=this.width/c;var j=this.height/d;var k=(a%g)*c;var l=(~~(a/g)%h)*d;B.save();B.translate(this.x+e,this.y+f);B.rotate(this.rot);B.translate(-e,-f);B.scale(i,j);B.drawImage(b,k,l,c,d,0,0,c,d);B.restore()}});var M=Atlas.createClass(L,{initialize:function(a,b,c){this.inherent(a,b,c);this.drawData;this.hitData},intersect:function(a,b){var c=this.hitData;var x=c[0].length;var y=c.length;var d=this.width;var e=this.height;var f=this.x;var g=this.y;for(var i=0;i<y;i++){for(var t=0;t<x;t++){if(c[i][t]==1&&f+t*d<a&&a<f+(t+1)*d&&g+i*e<b&&b<g+(i+1)*e)return true}}return false},draw:function(){var a=this.drawData;var x=a[0].length;var y=a.length;var b=this.width;var c=this.height;var d=this.x;var e=this.y;var i=0;var t=0;var f=A.height;var g=A.width;var h;var j=v[this.img];var k=this.spriteWidth;var l=this.spriteHeight;var m=this.width/2;var n=this.height/2;var o=j.width/k;var p=j.height/l;var q=this.width/k;var r=this.height/l;var s=(h%o)*k;var u=(~~(h/o)%p)*l;while(i<y){while(t<x){h=a[i][t];if(h>=0&&f>e+c*i&&e+c*(i+1)>0&&g>d+b*t&&d+b*(t+1)>0){var s=(h%o)*k;var u=(~~(h/o)%p)*l;B.save();B.translate(this.x,this.y);B.scale(q,r);B.drawImage(j,s,u,k,l,0,0,k,l);B.restore()}this.x+=b;t++}this.y+=c;i++;this.x=d;t=0}this.x=d;this.y=e}});var N=Atlas.createClass(H,{initialize:function(a,b,c,d){this.inherent();this.x=0;this.y=0;this.alpha=1;this.spaceWidth=0;if(d)this.font="'"+d+"'";else this.font="'Meiryo'";if(c)this.size=c+"pt";else this.size="10pt";if(a)this.string=a;else this.string="";if(b)this.col=b;else this.col="white"},setSize:function(a){this.size=a+"pt"},setFont:function(a){this.font="'"+a+"'"},setPosition:function(x,y){this.x=x;this.y=y},draw:function(){var x=this.x;var y=this.y;var a=this.string.split('<br>');var b=a.length;B.globalAlpha=this.alpha;B.font=this.size+" "+this.font;B.fillStyle=this.col;if(b>1){var c=B.measureText('a').width*1.5+this.spaceWidth;for(var i=0;i<b;i++){B.fillText(a[i],x,y);y+=c}}else B.fillText(this.string,x,y);B.globalAlpha=1}});var O=Atlas.createClass(Array,{initialize:function(){this.inherent()},add:function(){for(var i=0,n=arguments.length;i<n;i++){var a=arguments[i];if(typeof a.move==='function'){a.remove=false;this.push(a)}}},move:function(){var a=arguments.length;for(var i=0,n=this.length;i<n;i++){if(a>0)this[i].move.apply(this[i],arguments);else this[i].move();if(this[i].remove){this.splice(i,1);i--;n--}}}});Atlas.App=I;Atlas.Sprite=L;Atlas.Text=N;Atlas.Shape=K;Atlas.Group=O;Atlas.Map=M})();